<template>
    <lightning-card title="Administration - Quebec Property Search" icon-name="standard:settings">
        
        <!-- Loading Spinner -->
        <template if:true={isLoading}>
            <div class="slds-m-around_medium slds-text-align_center">
                <lightning-spinner alternative-text="Chargement..." size="medium"></lightning-spinner>
            </div>
        </template>

        <!-- Main Content -->
        <template if:false={isLoading}>
            <div class="slds-m-around_medium">
                
                <!-- Status Banner -->
                <template if:false={isFullyConfigured}>
                    <div class="slds-notify slds-notify_alert slds-alert_warning" role="alert">
                        <span class="slds-assistive-text">Attention</span>
                        <p class="slds-text-body_regular">
                            <strong>Configuration incomplète:</strong> veuillez saisir la clé API, tester la connexion et configurer les municipalités autorisées avant d'utiliser le composant.
                        </p>
                    </div>
                </template>

                <!-- Tabs Navigation -->
                <div class="slds-tabs_default">
                    <ul class="slds-tabs_default__nav" role="tablist">
                        <li class={configurationTabClass} role="presentation">
                            <a class="slds-tabs_default__link" role="tab" data-tab="configuration" onclick={handleTabChange}>
                                Configuration
                            </a>
                        </li>
                        <li class={helpTabClass} role="presentation">
                            <a class="slds-tabs_default__link" role="tab" data-tab="help" onclick={handleTabChange}>
                                Aide
                            </a>
                        </li>
                    </ul>

                    <!-- Configuration Tab Content -->
                    <div class="slds-tabs_default__content" role="tabpanel">
                        <template if:true={showConfigurationTab}>
                            <div class="slds-m-top_medium">
                                
                                <!-- API Configuration Section -->
                                <div class="slds-section slds-is-open">
                                    <h3 class="slds-section__title slds-theme_shade">
                                        <span class="slds-truncate slds-p-horizontal_small">
                                            Configuration API
                                        </span>
                                    </h3>
                                    <div class="slds-section__content slds-p-horizontal_small">
                                        
                                        <!-- API Key -->
                                        <div class="slds-grid slds-wrap slds-gutters slds-m-bottom_medium">
                                            <div class="slds-col slds-size_1-of-1 slds-medium-size_2-of-3">
                                                <lightning-input
                                                    type="password"
                                                    name="apiKey"
                                                    label="Clé API"
                                                    value={apiKey}
                                                    placeholder="Saisissez votre clé API"
                                                    onchange={handleInputChange}
                                                    data-field="apiKey"
                                                    field-level-help="Clé API fournie par Quebec Property Search pour accéder aux données."
                                                    required>
                                                </lightning-input>
                                            </div>
                                            <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3">
                                                <div class="slds-m-top_large">
                                                    <lightning-button
                                                        variant="neutral"
                                                        label={testButtonLabel}
                                                        onclick={handleTestConnection}
                                                        disabled={testButtonDisabled}
                                                        class="slds-m-right_small">
                                                    </lightning-button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Connection Status -->
                                        <template if:false={connectionStatus.unknown}>
                                            <div class="slds-m-bottom_medium">
                                                <div class="slds-media">
                                                    <div class="slds-media__figure">
                                                        <lightning-icon 
                                                            icon-name={connectionStatusIcon}
                                                            variant={connectionStatusVariant}
                                                            size="small">
                                                        </lightning-icon>
                                                    </div>
                                                    <div class="slds-media__body">
                                                        <p class="slds-text-body_regular">
                                                            <strong>État de la connexion:</strong> {connectionStatusText}
                                                        </p>
                                                        <p class="slds-text-body_small slds-text-color_weak">
                                                            {lastTestResult}
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>

                                        <!-- Service Status -->
                                        <div class="slds-m-bottom_medium">
                                            <lightning-input
                                                type="toggle"
                                                name="isActive"
                                                label="Service actif"
                                                checked={isActive}
                                                onchange={handleInputChange}
                                                data-field="isActive"
                                                field-level-help="Active ou désactive l'accès au service Quebec Property Search.">
                                            </lightning-input>
                                        </div>
                                    </div>
                                </div>

                                <!-- Municipalities Configuration Section -->
                                <div class="slds-section slds-is-open slds-m-top_medium">
                                    <h3 class="slds-section__title slds-theme_shade">
                                        <span class="slds-truncate slds-p-horizontal_small">
                                            Municipalités autorisées
                                        </span>
                                    </h3>
                                    <div class="slds-section__content slds-p-horizontal_small">
                                        
                                        <lightning-textarea
                                            name="municipalityCodes"
                                            label="Codes des municipalités"
                                            value={municipalityCodes}
                                            placeholder="Ex: 66102,66023,23027"
                                            onchange={handleInputChange}
                                            data-field="municipalityCodes"
                                            field-level-help="Saisissez les codes des municipalités séparés par des virgules. Ex: 66102 pour Kirkland, 66023 pour Montréal."
                                            rows="3">
                                        </lightning-textarea>
                                        
                                        <div class="slds-m-top_small">
                                            <p class="slds-text-body_small slds-text-color_weak">
                                                <strong>Exemples de codes :</strong><br/>
                                                • 66102 = Kirkland<br/>
                                                • 66023 = Montréal<br/>
                                                • 23027 = Québec
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Save Configuration -->
                                <div class="slds-m-top_large slds-text-align_center">
                                    <lightning-button
                                        variant="brand"
                                        label={saveButtonLabel}
                                        onclick={handleSaveConfiguration}
                                        disabled={saveButtonDisabled}
                                        class="slds-m-right_small">
                                    </lightning-button>
                                </div>
                            </div>
                        </template>

                        <!-- Help Tab Content -->
                        <template if:true={showHelpTab}>
                            <div class="slds-m-top_medium">
                                
                                <!-- Getting Started -->
                                <div class="slds-section slds-is-open">
                                    <h3 class="slds-section__title slds-theme_shade">
                                        <span class="slds-truncate slds-p-horizontal_small">
                                            Guide de démarrage
                                        </span>
                                    </h3>
                                    <div class="slds-section__content slds-p-horizontal_small">
                                        <ol class="slds-list_ordered">
                                            <li class="slds-m-bottom_small">
                                                <strong>Obtenir votre clé API :</strong> Contactez Quebec Property Search pour obtenir votre clé API unique.
                                            </li>
                                            <li class="slds-m-bottom_small">
                                                <strong>Configurer l'accès :</strong> Saisissez votre clé API dans le champ prévu à cet effet.
                                            </li>
                                            <li class="slds-m-bottom_small">
                                                <strong>Tester la connexion :</strong> Utilisez le bouton "Tester la connexion" pour vérifier que la clé fonctionne.
                                            </li>
                                            <li class="slds-m-bottom_small">
                                                <strong>Sélectionner les municipalités :</strong> Saisissez les codes des municipalités auxquelles votre organisation aura accès.
                                            </li>
                                            <li class="slds-m-bottom_small">
                                                <strong>Activer le service :</strong> Cochez "Service actif" pour permettre aux utilisateurs d'utiliser le composant.
                                            </li>
                                            <li class="slds-m-bottom_small">
                                                <strong>Sauvegarder :</strong> Cliquez sur "Sauvegarder la configuration" pour appliquer les changements.
                                            </li>
                                        </ol>
                                    </div>
                                </div>

                                <!-- Troubleshooting -->
                                <div class="slds-section slds-is-open slds-m-top_medium">
                                    <h3 class="slds-section__title slds-theme_shade">
                                        <span class="slds-truncate slds-p-horizontal_small">
                                            Résolution de problèmes
                                        </span>
                                    </h3>
                                    <div class="slds-section__content slds-p-horizontal_small">
                                        <dl class="slds-list_stacked">
                                            <dt class="slds-item_label slds-text-color_default slds-truncate">
                                                <strong>Le test de connexion échoue</strong>
                                            </dt>
                                            <dd class="slds-item_detail slds-text-color_weak slds-m-bottom_medium">
                                                Vérifiez que la clé API est correctement saisie. Contactez le support si le problème persiste.
                                            </dd>
                                            
                                            <dt class="slds-item_label slds-text-color_default slds-truncate">
                                                <strong>Les utilisateurs ne peuvent pas utiliser le composant</strong>
                                            </dt>
                                            <dd class="slds-item_detail slds-text-color_weak slds-m-bottom_medium">
                                                Vérifiez que le service est activé et qu'au moins une municipalité est configurée.
                                            </dd>
                                        </dl>
                                    </div>
                                </div>

                                <!-- Support Contact -->
                                <div class="slds-section slds-is-open slds-m-top_medium">
                                    <h3 class="slds-section__title slds-theme_shade">
                                        <span class="slds-truncate slds-p-horizontal_small">
                                            Support
                                        </span>
                                    </h3>
                                    <div class="slds-section__content slds-p-horizontal_small">
                                        <p class="slds-text-body_regular slds-m-bottom_small">
                                            Pour obtenir de l'aide ou signaler un problème :
                                        </p>
                                        <ul class="slds-list_dotted">
                                            <li>Email: support@quebecpropertysearch.com</li>
                                            <li>Documentation: https://docs.quebecpropertysearch.com</li>
                                            <li>Version du package: 1.0.0</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </template>
    </lightning-card>
</template>